---
title: "Fire_02_Explore_Model"
author: "Femke Keij S2647168"
date: '2022-07-21'
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clear working directory:
```{r}
rm(list = ls(all = TRUE)) 
```

Packages used:
```{r}
# for importing / working with tidy data
library(tidyverse)

# for arranging ggplots
library(patchwork)

# for ggplot aesthetics
library(directlabels)
library(RColorBrewer)

# for k-means clustering
library(factoextra)

# for computing trends in data
library(trend)
```

Random seed:
```{r}
set.seed(42)
```

Read in the data:
```{r}
# complete data set
fire_output <- read_csv(
  'data/processed/fire_full.csv')

# output data summary
fire_summary <- read_csv(
  'data/processed/fire_summary.csv')
# rename 'mean_burn_percentage' to 'burn_percentage'
fire_summary <- fire_summary %>%
  rename(burn_percentage = mean_burn_percentage)
```

# Visualising parameter space
Plot time series:
```{r}
p1 <- fire_summary %>%
  ggplot(mapping = aes(x = ticks, y = burn_percentage,
                       group = combination_number)) +
  geom_line(alpha = 0.2) +
  labs(y = 'percentage trees burned') +
  theme_minimal() +
  theme(panel.grid.minor = element_blank()) +
  facet_grid(~ directions,
             labeller = 'label_both')
```

Plot burn percentage at last tick as a function of density at start of simulation and number of directions:
```{r}
p2 <- fire_summary %>%
  group_by(combination_number) %>%
  filter(ticks == max(ticks)) %>%
  ggplot(mapping = (aes(x = density, y = burn_percentage,
                        group = as.factor(directions),
                        colour = as.factor(directions)))) +
  labs(x = 'tree density (%)',
       y = '% of burned trees at last tick',
       colour = 'number of directions') +
  geom_path (linewidth = 1) +
  theme_minimal()
```

Plot number of ticks against density:
```{r}
p3 <- fire_output %>%
  group_by(combination_number) %>%
  filter(ticks == max(ticks)) %>%
  ggplot(mapping = aes(x = density, y = ticks, 
                       colour = as.factor(directions))) +
  geom_point(alpha = 0.5) +
  labs(x = 'tree density (%)',
       y = 'number of ticks until fire extinguishes',
       colour = 'number of directions') +
  theme_minimal()
```

Plot both:
```{r}
p1 / (p2 + p3) +
  plot_layout(guides = 'collect')

ggsave('figures/fire_parameterspace.pdf')
```

# Identifying equifinality
The parameter space plots show equifinality, especially around the lowest and highest tree densities.

Apply a k-means clustering to the burn percentages at the middle and final timestep. Then see which parameter combinations end up in the same cluster.
Start by formatting the data for the analysis
```{r}
kmeans_data <- fire_summary %>%
  group_by(combination_number) %>%
  mutate(time_label = ifelse(ticks == max(ticks), 'end',
                             ifelse(ticks == floor(median(ticks)),
                                    'middle', '--'))) %>%
  filter(time_label %in% c('middle', 'end')) %>%
  select(combination_number, burn_percentage, time_label) %>%
  pivot_wider(names_from = time_label,
              values_from = burn_percentage) %>%
  select(middle, end) %>%
  scale() 
```

Determine optimal number of clusters:
- elbow method: we want to minimize the total within-cluster variation (or within-cluster sum of squares). we compute the wss for a number of different clusters, and then choose the number of clusters where we see the 'elbow' occur
- average silhouette method: this approach inspects how well each observation fits within its cluster. If the average is high, that indicates good clustering.
```{r}
# elbow method
fviz_nbclust(kmeans_data, kmeans, method = "wss")

# silhouette method
fviz_nbclust(kmeans_data, kmeans, method = "silhouette")
```
The optimal number of clusters is 2.

K-means clustering with 2 centers:
```{r}
clustering <- kmeans(kmeans_data, centers = 2, nstart = 25)

fviz_cluster(clustering, data = kmeans_data)
```

Now inspect which parameter combinations ended up in the same cluster.
```{r}
clustered_parameters <- fire_summary %>%
  select(combination_number,
         directions, density) %>%
  distinct() %>%
  add_column(cluster = clustering$cluster)


p1 <- clustered_parameters %>%
  ggplot(mapping = aes(x = as.factor(cluster),
                       y = density,
                       colour = as.factor(cluster),
                       fill = as.factor(cluster))) +
           geom_jitter(width = 0.2) +
           geom_boxplot(alpha = 0.1, width = 0.4,
                        outlier.colour = 'transparent') +
           theme_minimal() +
           labs(x = '2-means clusters',
                y = 'tree density') +
           theme(legend.position = 'none')

p2 <- clustered_parameters %>%
  ggplot(mapping = aes(x = as.factor(cluster),
                       y = directions,
                       colour = as.factor(cluster),
                       fill = as.factor(cluster))) +
           geom_jitter(width = 0.2) +
           geom_boxplot(alpha = 0.1, width = 0.4,
                        outlier.colour = 'transparent') +
           theme_minimal() +
           labs(x = '2-means clusters',
                y = ' number of directions') +
           theme(legend.position = 'none')

p1 + p2
```
The clusters show that we can distinguish fairly well between high and low tree densities based on the burn percentage during the simulation. However, it is difficult to distinguish between the directions. Therefore, we can conclude that there is equifinality for the number of directions.

# Identifying unidentifiable parameters


# Summary statistics
Some stats for the Fire model:
```{r}
summary(fire_output)
```

Check that the training and test data are similarly distributed:
```{r}
summary(fire_test)
```

```{r}
summary(fire_train)
```

The medians for the burn percentages are different.
```{r}
par(mfrow = c(1,3))
hist(fire_output$burn_percentage)
hist(fire_test$burn_percentage)
hist(fire_train$burn_percentage)
```
