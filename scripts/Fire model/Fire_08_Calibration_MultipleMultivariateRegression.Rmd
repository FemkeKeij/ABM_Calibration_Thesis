---
title: "Fire_08_Calibartion_MultipleMultivariateRegression"
author: "Femke Keij S2647168"
date: "2023-03-17"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preliminaries
Clear working directory & set random seed:
```{r}
rm(list = ls(all = TRUE))

set.seed(42)
```

Packages used:
```{r}
# for importing / working with tidy data
library(tidyverse)

# for ggplot
library(directlabels)
library(patchwork)
library(ggbeeswarm)

# for partial least squares
library(pls)
```

Source files for error computation and plotting functions:
```{r}
source('scripts/Fire model/Fire_ErrorFunctions.R')
```

Read in the data:
```{r}
# complete output data
fire_output <- read_csv('data/raw/fire_output.csv')

# training data
fire_train <- read_csv(
  'data/processed/fire_train.csv')
fire_train$directions <- as.factor(fire_train$directions)

# test data
fire_test <- read_csv(
  'data/processed/fire_test.csv')
fire_test$directions <- as.factor(fire_test$directions)
```

Random samples:
5, 10, 20, 30, 40, 50, 60, 70, and 80 $%$ of the total parameter space.
```{r}
N <- nrow(fire_output)
# range of (training) sample sizes to work with
n <- c(0.05 * N, 0.1 * N, 0.2 * N, 0.3 * N, 0.4 * N, 0.5 * N,
       0.6 * N, 0.7 * N, nrow(fire_train))
```

# Fitting
```{r}
PLSfitting <- function(ticks = FALSE){
  # table to store all output
  length_tib <- sum(nrow(fire_test) * length(n))
  pls_results <- tibble(direction_true = numeric(length_tib),
                              direction_pred = numeric(length_tib),
                              density_true = numeric(length_tib),
                              density_pred = numeric(length_tib),
                              burn_true = numeric(length_tib),
                              burn_pred = numeric(length_tib),
                              n = numeric(length_tib),
                              ticks_included = numeric(length_tib))
  # vector to store mean density in each training sample
  # (to calculate point prediction performance later on)
  density_means <- numeric(length(n))
  # list to store fitted regression lines
  pls_fits <- list()

  count <- 1
  
  # for each sample size
  for(i in 1:length(n)){
    # sample training set
    ind_sample <- sample(1:nrow(fire_train), size = n[i])
    fire_train_sub <- fire_train[ind_sample, ]
    # calculate and save mean density in training set
    density_means[i] <- mean(fire_train_sub$density)
    # create dummy variables to use for directions
    fire_use <- fire_train_sub %>%
      mutate(true_four = ifelse(directions == '4', 1, 0),
             true_eight = ifelse(directions == '8', 1, 0))
    
    if(ticks == TRUE){
      # partial least squares to predict density and directions with ticks
      fit <- plsr(cbind(density, true_four, true_eight) ~
                    burn_percentage + ticks,
                  data = fire_use, validation = 'LOO',
                  scale = TRUE)
    } else{
      # partial least squares to predict density and directions without ticks
      fit <- plsr(cbind(density, true_four, true_eight) ~
                    burn_percentage,
                  data = fire_use, validation = 'LOO',
                  scale = TRUE)
    }
    # cross-validation to determine number of components
    ncomp.cv <- crossval(fit)$ncomp
    
    # predict test data using fitted PLS
    pred <- predict(fit, newdata = fire_test, ncomp = ncomp.cv)
    predicted <- data.frame(density_pred = pred[, 1, 1],
                   direction_four = pred[, 2, 1],
                   direction_eight = pred[, 3, 1],
                   direction_pred = numeric(nrow(pred)))

    # correct the predicted directions
    # to match test data
    # the predictions for the dummy variables can be interpreted
    # as class probabilities
    for(k in 1:nrow(fire_test)){
      if(predicted$direction_four[k] > predicted$direction_eight[k]){
        predicted$direction_pred[k] <- 4
      } else{
        predicted$direction_pred[k] <- 8
      }
    }
    
    # for each instance of the test data
    for(j in 1:nrow(fire_test)){
      # find an instance in the training data that matches the directions
      # and density
      if(predicted$density_pred[j] < 1){
        predicted$density_pred[j] <- 1
      } else if (predicted$density_pred[j] > 99){
        predicted$density_pred[j] <- 99
      }
        
      ind <- which(fire_train$density == round(predicted$density_pred[j]) &
                     fire_train$directions ==
                     predicted$direction_pred[j])
      if(length(ind) > 1){
        ind <- sample(ind, size = 1)
      }
      # find predicted burn percentage based on training data
      burn_pred <- fire_train$burn_percentage[ind]
      
      # store all results in table
      pls_results$direction_true[count] <- fire_test$directions[j]
      pls_results$direction_pred[count] <-
        predicted$direction_pred[j]
      pls_results$density_true[count] <- fire_test$density[j]
      pls_results$density_pred[count] <- predicted$density[j]
      pls_results$burn_true[count] <- fire_test$burn_percentage[j]
      pls_results$burn_pred[count] <- burn_pred
      pls_results$n[count] <- n[i]
      pls_results$ticks_included[count] <- if(ticks){'yes'}else{'no'}
      
      count <- count + 1
    }
    # store regression fit
    pls_fits <- append(pls_fits, fit)
    
    print(c('finished fitting sample size ', n[i]))
  }
  
  # correct format of direction_true variable
  pls_results %>%
    mutate(direction_true = replace(direction_true, direction_true == 1, 4),
         direction_true = replace(direction_true, direction_true == 2, 8)) ->
    pls_results
  
  # return table with results, density means, and fitted regression lines
  return(list(pls_results, density_means, pls_fits))
}
```

```{r}
# fit PLS with ticks
pls_results_ticks <- PLSfitting(ticks = TRUE)
density_means_ticks <- pls_results_ticks[[2]]
pls_fits_ticks <- pls_results_ticks[[3]]
pls_results_ticks <- pls_results_ticks[[1]]

# fit PLS without ticks
pls_results_noticks <- PLSfitting(ticks = FALSE)
density_means_noticks <- pls_results_noticks[[2]]
pls_fits_noticks <- pls_results_noticks[[3]]
pls_results_noticks <- pls_results_noticks[[1]]
```

```{r}
# run error calculations
pls_errors_ticks <- ComputeErrors(pls_results_ticks,
                                  ticks = TRUE,
                                  density_means = density_means_ticks,
                                  pred_int_included = FALSE)
pls_errors_noticks <- ComputeErrors(pls_results_noticks,
                                    ticks = FALSE,
                                    density_means = density_means_noticks,
                                    pred_int_included = FALSE)
```

Merge results
```{r}
pls_results <- rbind(pls_results_noticks,
                            pls_results_ticks)
write_csv(pls_results,
          'data/processed/fire_partialleastsquares_results.csv')

pls_errors <- rbind(pls_errors_noticks, pls_errors_ticks)
write_csv(pls_errors,
          'data/processed/fire_partialleastsquares_errors.csv')
``` 

# Plots
```{r}
# pls_results <- read_csv('data/processed/fire_partialleastsquares_results.csv')

# pls_errors <- read_csv('data/processed/fire_partialleastsquares_errors.csv')
```

## Errors
Fix results and errors data frames:
```{r}
pls_results <- pls_results %>%
  mutate(n = factor(n),
         direction_true = factor(direction_true),
         direction_pred = factor(direction_pred),
         direction_correct = (direction_pred == direction_true))

pls_errors <- pls_errors %>%
  mutate(n = factor(n))
```

### Predicted vs. true
Predicted vs. true for density, directions, and burn percentage
```{r}
p1 <- PlotPredTrueDensity(pls_results, n = 1584)
p2 <- PlotPredTrueDirection(pls_results, n = 1584)
p3 <- PlotPredTrueBurn(pls_results, n = 1584)

p1 / p2 / p3
```
Predicted vs. true density (largest sample size only):
```{r}
PlotPredTrueDensity(pls_results, n = 1584)

ggsave('figures/fire_pls_predtrue_density.pdf')
```
Confusion matrix for predicted vs. true directions:
```{r}
PlotPredTrueDirection(pls_results, n = 1584)

ggsave('figures/fire_pls_predtrue_direction.pdf')
```
Predicted vs. true burn percentage (largest sample size only):
```{r}
PlotPredTrueBurn(pls_results, n = 1584)

ggsave('figures/fire_pls_predtrue_burn.pdf')
```
### Parameters
% correctly predicted parameters (density & directions):
```{r}
PlotPercCorrectParams(pls_errors, n_plot = c(99, 792, 1584))

ggsave('figures/fire_pls_perc_correct.pdf')
```
RMSE, NRMSE, point prediction performance, and coverage for density parameter:
```{r}
PlotErrorsDensity(pls_errors, n_plot = c(99, 792, 1584))

ggsave('figures/fire_pls_density_metrics.pdf')
```
F1, kappa score, and MCC for directions:
```{r}
PlotErrorsDirections(pls_errors, n_plot = c(99, 792, 1584))

ggsave('figures/fire_pls_directions_metrics.pdf')
```
### Outcome variable
RMSE for burn percentage:
```{r}
PlotRMSEOut(pls_errors, n_plot = c(99, 792, 1584))

ggsave('figures/fire_pls_RMSE_burn.pdf')
```

## Model fit
