---
title: "WolfSheep_03_CreateTrainingData"
author: "Femke Keij S2647168"
date: "2023-07-12"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clear working directory:
```{r}
rm(list = ls(all = TRUE)) 
```

Packages used:
```{r}
# for importing / working with tidy data
library(tidyverse)

# for arranging ggplots
library(patchwork)

# for ggplot aesthetics
library(directlabels)
library(RColorBrewer)

# for computing trends in data
library(trend)
```

Random seed:
```{r}
set.seed(42)
```

Read in the data:
```{r}
# complete data set
ws_full_clean <- read_csv(
  'data/processed/wolfsheep_full.csv')

# output data summary
ws_summary_clean <- read_csv(
  'data/processed/wolfsheep_summary.csv')
ws_summary_clean <- ws_summary_clean %>%
  rename(sheep = mean_sheep,
         wolves = mean_wolves,
         grass = mean_grass)
```

# Mimic real-world data: introduce random noise
ON THE OUTPUT:
Noise is maximum 20% of the mean output value it is added to (such that smaller values can be as noisy as large ones). How much noise is added is determined by a N(0, 6). 
```{r}
# for the summarised data
ws_summary_noise <- ws_summary_clean %>%
  # per parameter combination
  group_by(combination_number) %>%
  # compute mean sheep, grass, wolves over full time series
  mutate(mean_sheep = mean(sheep),
         mean_wolves = mean(wolves),
         mean_grass = mean(grass)) %>%
  # add noise to each value of sheep, grass, and wolves
  rowwise %>%
  mutate(sheep_noise = sheep + mean_sheep *
           rnorm(n = 1, mean = 0, sd = 6) / 100,
         wolves_noise = wolves + mean_wolves *
           rnorm(n = 1, mean = 0, sd = 6) / 100,
         grass_noise = grass + mean_grass *
           rnorm(n = 1, mean = 0, sd = 6) / 100) %>%
  # add a correction for values < 0, since it's in this case not possible for values to be negative
  mutate(sheep_noise = ifelse(sheep_noise < 0, 0, sheep_noise),
         wolves_noise = ifelse(wolves_noise < 0, 0, wolves_noise),
         grass_noise = ifelse(grass_noise < 0, 0, grass_noise))

# for the full data
ws_full_noise <- ws_full_clean %>%
  # per parameter combination
  group_by(combination_number, run) %>%
  # compute mean sheep, grass, wolves over full time series
  mutate(mean_sheep = mean(sheep),
         mean_wolves = mean(wolves),
         mean_grass = mean(grass)) %>%
  # add noise to each value of sheep, grass, and wolves
  rowwise %>%
  mutate(sheep_noise = sheep + mean_sheep *
           rnorm(n = 1, mean = 0, sd = 6) / 100,
         wolves_noise = wolves + mean_wolves *
           rnorm(n = 1, mean = 0, sd = 6) / 100,
         grass_noise = grass + mean_grass *
           rnorm(n = 1, mean = 0, sd = 6) / 100) %>%
  # add a correction for values < 0, since it's in this case not possible for values to be negative
  mutate(sheep_noise = ifelse(sheep_noise < 0, 0, sheep_noise),
         wolves_noise = ifelse(wolves_noise < 0, 0, wolves_noise),
         grass_noise = ifelse(grass_noise < 0, 0, grass_noise))
```

Check that the noise was added properly:
```{r}
# sheep
p_sheep <- ws_summary_noise %>%
  ggplot(mapping = aes(x = sheep, y = sheep_noise)) +
  geom_point(alpha = 0.5) +
  geom_abline(intercept = 0, slope = 1,
              colour = 'darkgreen', lty = 2) +
  labs(x = 'sheep original', y = 'sheep noise') +
  theme_minimal()

# wolves
p_wolves <- ws_summary_noise %>%
  ggplot(mapping = aes(x = wolves, y = wolves_noise)) +
  geom_point(alpha = 0.5) +
  geom_abline(intercept = 0, slope = 1,
              colour = 'darkgreen', lty = 2) +
  labs(x = 'wolves original', y = 'wolves noise') +
  theme_minimal()

# grass
p_grass <- ws_summary_noise %>%
  ggplot(mapping = aes(x = grass, y = grass_noise)) +
  geom_point(alpha = 0.5) +
  geom_abline(intercept = 0, slope = 1,
              colour = 'darkgreen', lty = 2) +
  labs(x = 'grass original', y = 'grass noise') +
  theme_minimal()

p_sheep + p_wolves + p_grass
```

IN TIME:
Time series are shifted by a maximum of 10 time steps. The amount of noise added is sampled randomly from (-10 ; 10).
```{r}
# for the summarised runs
ws_summary_noise <- ws_summary_noise %>%
  group_by(combination_number) %>%
  rowwise %>%
  mutate(ticks_noise = ticks + sample(-10:10, 1))

# for the full data
ws_full_noise <- ws_full_noise %>%
  group_by(combination_number, run) %>%
  rowwise %>%
  mutate(ticks_noise = ticks + sample(-10:10, 1))
```

# Summarise data into time series
Make the following summaries
- End point values only;
- Output values every 10 time steps, as well as mean, minimum, maximum, standard deviation, and trend of the output;
- Output values every 20 time steps, as well as mean, minimum, maximum, standard deviation, and trend of the output;
- Output values every 50 time steps, as well as mean, minimum, maximum, standard deviation, and trend of the output;
- Not summarised (the full time series is kept);

```{r}
TimeSeriesSummarising <- function(data, full = FALSE,
                                  timesteps = TRUE,
                                  noise = TRUE){
  # determine which parameters to use
  parameter_sheep = ifelse(noise, 'sheep_noise', 'sheep')
  parameter_wolves = ifelse(noise, 'wolves_noise', 'wolves')
  parameter_grass = ifelse(noise, 'grass_noise', 'grass')
  
  if(full & timesteps){
    data_return <- data %>%
      # per parameter combination & run number
      group_by(combination_number, run) %>%
      # compute mean, min, max, sd, and trend
      mutate(mean_sheep = mean(get(parameter_sheep)),
             min_sheep = min(get(parameter_sheep)),
             max_sheep = max(get(parameter_sheep)),
             sd_sheep = sd(get(parameter_sheep)),
             trend_sheep = 
               sens.slope(get(parameter_sheep))$estimates,
             mean_wolves = mean(get(parameter_wolves)),
             min_wolves = min(get(parameter_wolves)),
             max_wolves = max(get(parameter_wolves)),
             sd_wolves = max(get(parameter_wolves)),
             trend_wolves =
               sens.slope(get(parameter_wolves))$estimates,
             mean_grass = mean(get(parameter_grass)),
             min_grass = min(get(parameter_grass)),
             max_grass = max(get(parameter_grass)),
             sd_grass = sd(get(parameter_grass)),
             trend_grass = 
               sens.slope(get(parameter_grass))$estimates) %>%
      # filter out the time steps of interest
      filter(ifelse(noise, ticks_noise %% 10 == 0,
                    ticks %% 10 == 0))
  } else if (!full & timesteps){
    data_return <- data %>%
      # per parameter combination
      group_by(combination_number) %>%
      # compute mean, min, max, sd, and trend
      mutate(mean_sheep = mean(get(parameter_sheep)),
             min_sheep = min(get(parameter_sheep)),
             max_sheep = max(get(parameter_sheep)),
             sd_sheep = sd(get(parameter_sheep)),
             trend_sheep = 
               sens.slope(get(parameter_sheep))$estimates,
             mean_wolves = mean(get(parameter_wolves)),
             min_wolves = min(get(parameter_wolves)),
             max_wolves = max(get(parameter_wolves)),
             sd_wolves = max(get(parameter_wolves)),
             trend_wolves =
               sens.slope(get(parameter_wolves))$estimates,
             mean_grass = mean(get(parameter_grass)),
             min_grass = min(get(parameter_grass)),
             max_grass = max(get(parameter_grass)),
             sd_grass = sd(get(parameter_grass)),
             trend_grass = 
               sens.slope(get(parameter_grass))$estimates) %>%
      # filter out the time steps of interest
      filter(ifelse(noise, ticks_noise %% 10 == 0,
                    ticks %% 10 == 0))
  } else if (full & !timesteps){
    data_return <- data %>%
      # per parameter combination & run
      group_by(combination_number, run) %>%
      filter(ticks == max(ticks))
  } else {
    data_return <- data %>%
      # per parameter combination
      group_by(combination_number) %>%
      filter(ticks == max(ticks))
  }
  return(data_return)
}
```

```{r}
# summarised runs, no noise, full time series
ws_summary_clean_timeseries <- ws_summary_clean %>%
  mutate(sample_size = 40,
         sample_method = 'trial',
         summarised_runs = 'summarised',
         noise = 'clean',
         datapoints = 'timeseries')

# summarised runs, noise, full time series
ws_summary_noise_timeseries <- ws_summary_noise %>%
  mutate(sample_size = 40,
         sample_method = 'trial',
         summarised_runs = 'summarised',
         noise = 'noise',
         datapoints = 'timeseries')

# summarised runs, no noise, timesteps
ws_summary_clean_timesteps <- TimeSeriesSummarising(
  ws_summary_clean, full = FALSE, timesteps = TRUE, noise = FALSE) %>%
  mutate(sample_size = 40,
         sample_method = 'trial',
         summarised_runs = 'summarised',
         noise = 'clean',
         datapoints = 'timesteps')

# summarised runs, noise, timesteps
ws_summary_noise_timesteps <- TimeSeriesSummarising(
  ws_summary_noise, full = FALSE, timesteps = TRUE, noise = TRUE) %>%
  mutate(sample_size = 40,
         sample_method = 'trial',
         summarised_runs = 'summarised',
         noise = 'noise',
         datapoints = 'timesteps')

# summarised runs, no noise, endpoints only
ws_summary_clean_endpoints <- TimeSeriesSummarising(
  ws_summary_clean, full = FALSE, timesteps = FALSE, noise = FALSE) %>%
  mutate(sample_size = 40,
         sample_method = 'trial',
         summarise_runs = 'summarised',
         noise = 'clean',
         datapoints = 'endpoints')

# summarised runs, noise, endpoints only
ws_summary_noise_endpoints <- TimeSeriesSummarising(
  ws_summary_noise, full = FALSE, timesteps = FALSE, noise = TRUE) %>%
  mutate(sample_size = 40,
         sample_method = 'trial',
         summarise_runs = 'summarised',
         noise = 'noise',
         datapoints = 'endpoints')

# unsummarised runs, no noise, full time series
ws_full_clean_timeseries <- ws_full_clean %>%
  mutate(sample_size = 40,
         sample_method = 'trial',
         summarise_runs = 'full',
         noise = 'clean',
         datapoints = 'timeseries')

# unsummarised runs, noise, full time series
ws_full_noise_timeseries <- ws_full_clean %>%
  mutate(sample_size = 40,
         sample_method = 'trial',
         summarise_runs = 'full',
         noise = 'noise',
         datapoints = 'timeseries')

# unsummarised runs, no noise, timesteps
ws_full_clean_timesteps <- TimeSeriesSummarising(
  ws_full_clean, full = TRUE, timesteps = TRUE, noise = FALSE) %>%
  mutate(sample_size = 40,
         sample_method = 'trial',
         summarise_runs = 'full',
         noise = 'clean',
         datapoints = 'timesteps')

# unsummarised runs, noise, timesteps
ws_full_noise_timesteps <- TimeSeriesSummarising(
  ws_full_noise, full = TRUE, timesteps = TRUE, noise = TRUE) %>%
  mutate(sample_size = 40,
         sample_method = 'trial',
         summarise_runs = 'full',
         noise = 'noise',
         datapoints = 'timesteps')

# unsummarised runs, no noise, endpoints only
ws_full_clean_endpoints <- TimeSeriesSummarising(
  ws_full_clean, full = TRUE, timesteps = FALSE, noise = FALSE) %>%
  mutate(sample_size = 40,
         sample_method = 'trial',
         summarise_runs = 'full',
         noise = 'clean',
         datapoints = 'endpoints')

# unsummarised runs, noise, endpoints only
ws_full_noise_endpoints <- TimeSeriesSummarising(
  ws_full_noise, full = TRUE, timesteps = FALSE, noise = TRUE) %>%
  mutate(sample_size = 40,
         sample_method = 'trial',
         summarise_runs = 'full',
         noise = 'clean',
         datapoints = 'endpoints')

# merge into 1 file and save as a complete training data set
ws_training <- bind_rows(ws_summary_clean_timeseries,
                         ws_summary_noise_timeseries,
                         ws_summary_clean_timesteps,
                         ws_summary_noise_timesteps,
                         ws_summary_clean_endpoints,
                         ws_summary_noise_endpoints,
                         ws_full_clean_timeseries,
                         ws_full_noise_timeseries,
                         ws_full_clean_timesteps,
                         ws_full_noise_timesteps,
                         ws_full_clean_endpoints,
                         ws_full_noise_endpoints)

ws_training %>%
  write_csv(file = 'data/training/wolfsheep_training.csv')
```

########################### not yet sure if I want to use this ########
Reshape data:
```{r}
# extend all data to 500 ticks

# new data frame to store extended data
ws_summary_timesteps_new <- ws_summary_timesteps[1,]

# per parameter combination
for(i in unique(ws_summary_timesteps$combination_number)){
  # extract data for parameter combination
  work_with <- ws_summary_timesteps %>%
    filter(combination_number == i)
  
  # if data contains less than 500 ticks
  if(max(work_with$ticks) < 500){
    # register last tick included
    max_ticks <- max(work_with$ticks)
    
    # data to extend to 500 ticks
    add_rows <- work_with %>%
      filter(ticks == max_ticks)
    
    # ticks to add
    add_ticks <- seq(from = max_ticks + 10, to = 500, by = 10)
    
    # to store new data
    new_df <- add_rows
    
    # create data frame with last tick data, extending
    # for all required ticks
    for(i in 1:length(add_ticks)){
      new_df <- bind_rows(new_df, add_rows)
    }
    
    # set ticks to run until 500
    new_df$ticks <- c(max_ticks, add_ticks)
    # add original data to extended data
    new_df <- bind_rows(work_with, new_df)
    # to send back to complete dataframe
    work_with <- new_df
  }
  # fill out new data frame with extended data
  # or original data where it didn't need to be extended
  ws_summary_timesteps_new <- bind_rows(ws_summary_timesteps_new, work_with)
}
# remove set-up data row
ws_summary_timesteps_new <- ws_summary_timesteps_new[-1, ] %>%
  distinct()

# pivot wider so that each time step is a data column
# each parameter combination will have 1 row of data
ws_summary_timesteps <- ws_summary_timesteps_new %>%
  filter(ticks %in% seq(from = 10, to = 500, by = 10)) %>%
  pivot_wider(names_from = ticks,
              values_from = c(sheep, wolves, grass,
                              sheep_noise, wolves_noise, grass_noise))
```

Save all data frames:
```{r}
# complete data (for time series analysis)
ws_summary %>%
  write_csv(file = 'data/processed/wolfsheep_timeseries_training.csv')
# time steps
ws_summary_timesteps %>%
  write_csv(file = 'data/processed/wolfsheep_timesteps_training.csv')
```