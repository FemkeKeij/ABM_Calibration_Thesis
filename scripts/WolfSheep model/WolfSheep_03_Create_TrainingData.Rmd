---
title: "WolfSheep_03_CreateTrainingData"
author: "Femke Keij S2647168"
date: "2023-07-12"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clear working directory:
```{r}
rm(list = ls(all = TRUE)) 
```

Packages used:
```{r}
# for importing / working with tidy data
library(tidyverse)

# for arranging ggplots
library(patchwork)

# for ggplot aesthetics
library(directlabels)
library(RColorBrewer)

# for computing trends in data
library(trend)
```

Random seed:
```{r}
set.seed(42)
```

Read in the data:
```{r}
# complete data set
ws_full_clean <- read_csv(
  'data/processed/wolfsheep_full.csv') %>%
  rename(wolves_reproduce = wolf_reproduce,
         wolves_gain_from_food = wolf_gain_from_food)

# output data summary
ws_summary_clean <- read_csv(
  'data/processed/wolfsheep_summary.csv')
ws_summary_clean <- ws_summary_clean %>%
  rename(sheep = mean_sheep,
         wolves = mean_wolves,
         grass = mean_grass)
```

# Mimic real-world data: introduce random noise
ON THE OUTPUT:
Noise is maximum 20% of the mean output value it is added to (such that smaller values can be as noisy as large ones). How much noise is added is determined by a N(0, 6). 
```{r}
# for the summarised data
ws_summary_noise <- ws_summary_clean %>%
  # per parameter combination
  group_by(combination_number) %>%
  # compute mean sheep, grass, wolves over full time series
  mutate(mean_sheep = mean(sheep),
         mean_wolves = mean(wolves),
         mean_grass = mean(grass)) %>%
  # add noise to each value of sheep, grass, and wolves
  rowwise %>%
  mutate(sheep_noise = sheep + mean_sheep *
           rnorm(n = 1, mean = 0, sd = 6) / 100,
         wolves_noise = wolves + mean_wolves *
           rnorm(n = 1, mean = 0, sd = 6) / 100,
         grass_noise = grass + mean_grass *
           rnorm(n = 1, mean = 0, sd = 6) / 100) %>%
  # add a correction for values < 0, since it's in this case not possible for values to be negative
  mutate(sheep_noise = ifelse(sheep_noise < 0, 0, sheep_noise),
         wolves_noise = ifelse(wolves_noise < 0, 0, wolves_noise),
         grass_noise = ifelse(grass_noise < 0, 0, grass_noise))

# for the full data
ws_full_noise <- ws_full_clean %>%
  # per parameter combination
  group_by(combination_number, run) %>%
  # compute mean sheep, grass, wolves over full time series
  mutate(mean_sheep = mean(sheep),
         mean_wolves = mean(wolves),
         mean_grass = mean(grass)) %>%
  # add noise to each value of sheep, grass, and wolves
  rowwise %>%
  mutate(sheep_noise = sheep + mean_sheep *
           rnorm(n = 1, mean = 0, sd = 6) / 100,
         wolves_noise = wolves + mean_wolves *
           rnorm(n = 1, mean = 0, sd = 6) / 100,
         grass_noise = grass + mean_grass *
           rnorm(n = 1, mean = 0, sd = 6) / 100) %>%
  # add a correction for values < 0, since it's in this case not possible for values to be negative
  mutate(sheep_noise = ifelse(sheep_noise < 0, 0, sheep_noise),
         wolves_noise = ifelse(wolves_noise < 0, 0, wolves_noise),
         grass_noise = ifelse(grass_noise < 0, 0, grass_noise))
```

Check that the noise was added properly:
```{r}
# sheep
p_sheep <- ws_summary_noise %>%
  ggplot(mapping = aes(x = sheep, y = sheep_noise)) +
  geom_point(alpha = 0.5) +
  geom_abline(intercept = 0, slope = 1,
              colour = 'darkgreen', lty = 2) +
  labs(x = 'sheep original', y = 'sheep noise') +
  theme_minimal()

# wolves
p_wolves <- ws_summary_noise %>%
  ggplot(mapping = aes(x = wolves, y = wolves_noise)) +
  geom_point(alpha = 0.5) +
  geom_abline(intercept = 0, slope = 1,
              colour = 'darkgreen', lty = 2) +
  labs(x = 'wolves original', y = 'wolves noise') +
  theme_minimal()

# grass
p_grass <- ws_summary_noise %>%
  ggplot(mapping = aes(x = grass, y = grass_noise)) +
  geom_point(alpha = 0.5) +
  geom_abline(intercept = 0, slope = 1,
              colour = 'darkgreen', lty = 2) +
  labs(x = 'grass original', y = 'grass noise') +
  theme_minimal()

p_sheep + p_wolves + p_grass
```

IN TIME:
Time series are shifted by a maximum of 10 time steps. The amount of noise added is sampled randomly from (-10 ; 10).
```{r}
# for the summarised runs
ws_summary_noise <- ws_summary_noise %>%
  group_by(combination_number) %>%
  mutate(ticks_noise = ticks + sample(-10:10, 1))

# for the full data
ws_full_noise <- ws_full_noise %>%
  group_by(combination_number, run) %>%
  mutate(ticks_noise = ticks + sample(-10:10, 1))
```

# Summarise data into time series
Make the following summaries
- End point values only;
- Output values every 10 time steps, as well as mean, minimum, maximum, standard deviation, and trend of the output;
- Output values every 20 time steps, as well as mean, minimum, maximum, standard deviation, and trend of the output;
- Output values every 50 time steps, as well as mean, minimum, maximum, standard deviation, and trend of the output;
- Not summarised (the full time series is kept);

```{r}
TimeSeriesSummarising <- function(data, full = FALSE,
                                  timesteps = TRUE){
  
  if(full){
    data_return <- data %>%
      # per parameter combination & run number
      group_by(combination_number, run) %>%
      # compute mean, min, max, sd, and trend
      mutate(mean_sheep = mean(sheep),
             mean_sheep_noise = mean(sheep_noise),
             min_sheep = min(sheep),
             min_sheep_noise = min(sheep_noise),
             max_sheep = max(sheep),
             max_sheep_noise = max(sheep_noise),
             sd_sheep = sd(sheep),
             sd_sheep_noise = sd(sheep_noise),
             trend_sheep = sens.slope(sheep)$estimates,
             trend_sheep_noise = sens.slope(sheep_noise)$estimates,
             mean_wolves = mean(wolves),
             mean_wolves_noise = mean(wolves_noise),
             min_wolves = min(wolves),
             min_wolves_noise = min(wolves_noise),
             max_wolves = max(wolves),
             max_wolves_noise = max(wolves_noise),
             sd_wolves = sd(wolves),
             sd_wolves_noise = sd(wolves_noise),
             trend_wolves = sens.slope(wolves)$estimates,
             trend_wolves_noise = sens.slope(wolves_noise)$estimates,
             mean_grass = mean(grass),
             mean_grass_noise = mean(grass_noise),
             min_grass = min(grass),
             min_grass_noise = min(grass_noise),
             max_grass = max(grass),
             max_grass_noise = max(grass_noise),
             sd_grass = sd(grass),
             sd_grass_noise = sd(grass_noise),
             trend_grass = sens.slope(grass)$estimates,
             tend_grass_noise = sens.slope(grass_noise)$estimates)
  } else {
    data_return <- data %>%
      # per parameter combination
      group_by(combination_number) %>%
      # compute mean, min, max, sd, and trend
      mutate(mean_sheep = mean(sheep),
             mean_sheep_noise = mean(sheep_noise),
             min_sheep = min(sheep),
             min_sheep_noise = min(sheep_noise),
             max_sheep = max(sheep),
             max_sheep_noise = max(sheep_noise),
             sd_sheep = sd(sheep),
             sd_sheep_noise = sd(sheep_noise),
             trend_sheep = sens.slope(sheep)$estimates,
             trend_sheep_noise = sens.slope(sheep_noise)$estimates,
             mean_wolves = mean(wolves),
             mean_wolves_noise = mean(wolves_noise),
             min_wolves = min(wolves),
             min_wolves_noise = min(wolves_noise),
             max_wolves = max(wolves),
             max_wolves_noise = max(wolves_noise),
             sd_wolves = sd(wolves),
             sd_wolves_noise = sd(wolves_noise),
             trend_wolves = sens.slope(wolves)$estimates,
             trend_wolves_noise = sens.slope(wolves_noise)$estimates,
             mean_grass = mean(grass),
             mean_grass_noise = mean(grass_noise),
             min_grass = min(grass),
             min_grass_noise = min(grass_noise),
             max_grass = max(grass),
             max_grass_noise = max(grass_noise),
             sd_grass = sd(grass),
             sd_grass_noise = sd(grass_noise),
             trend_grass = sens.slope(grass)$estimates,
             tend_grass_noise = sens.slope(grass_noise)$estimates)
  }
  
  if(timesteps){
    data_return <- data_return %>%
      filter(ticks %% 10 == 0 | ticks_noise %% 10 == 0)
  } else {
    if(full){
      data_return <- data_return %>%
        group_by(combination_number, run) %>%
        filter(ticks == max(ticks))
    } else {
      data_return <- data_return %>%
        group_by(combination_number) %>%
        filter(ticks == max(ticks))
    }
  }
  
  return(data_return)
}
```

```{r}
# summarised runs, full time series
ws_summary_timeseries <- ws_summary_noise %>%
  mutate(sample_size = 40,
         sample_method = 'trial',
         summarise_runs = 'summarised',
         datapoints = 'timeseries') %>%
  select(- c(mean_sheep, mean_grass, mean_wolves))

# not summarised, full time series
ws_full_timeseries <- ws_full_noise %>%
  mutate(sample_size = 40,
         sample_method = 'trial',
         summarise_runs = 'full',
         datapoints = 'timeseries') %>%
  select(- c(mean_sheep, mean_grass, mean_wolves))

# summarised runs, timesteps
ws_summary_timesteps <- TimeSeriesSummarising(
  ws_summary_noise, full = FALSE,
  timesteps = TRUE) %>%
  mutate(sample_size = 40,
         sample_method = 'trial',
         summarise_runs = 'summarised',
         datapoints = 'timesteps')

# not summarised, timesteps
ws_full_timesteps <- TimeSeriesSummarising(
  ws_full_noise, full = TRUE,
  timesteps = TRUE) %>%
  mutate(sample_size = 40,
         sample_method = 'trial',
         summarise_runs = 'full',
         datapoints = 'timesteps')

# summarised, endpoints only
ws_summary_endpoints <- TimeSeriesSummarising(
  ws_summary_noise, full = FALSE,
  timesteps = FALSE) %>%
  mutate(sample_size = 40,
         sample_method = 'trial',
         summarise_runs = 'summarised',
         datapoints = 'endpoints')

# not summarised, endpoints only
ws_full_endpoints <- TimeSeriesSummarising(
  ws_full_noise, full = TRUE,
  timesteps = FALSE) %>%
  mutate(sample_size = 40,
         sample_method = 'trial',
         summarise_runs = 'full',
         datapoints = 'endpoints')

# merge into 1 file and save as a complete training data set
ws_training <- bind_rows(ws_summary_timeseries,
                         ws_summary_timesteps,
                         ws_summary_endpoints,
                         ws_full_timeseries,
                         ws_full_timesteps,
                         ws_full_endpoints)

ws_training %>%
  write_csv(file = 'data/training/wolfsheep_training.csv')
```

########################### not yet sure if I want to use this ########
Reshape data:
```{r}
# extend all data to 500 ticks

# new data frame to store extended data
ws_summary_timesteps_new <- ws_summary_timesteps[1,]

# per parameter combination
for(i in unique(ws_summary_timesteps$combination_number)){
  # extract data for parameter combination
  work_with <- ws_summary_timesteps %>%
    filter(combination_number == i)
  
  # if data contains less than 500 ticks
  if(max(work_with$ticks) < 500){
    # register last tick included
    max_ticks <- max(work_with$ticks)
    
    # data to extend to 500 ticks
    add_rows <- work_with %>%
      filter(ticks == max_ticks)
    
    # ticks to add
    add_ticks <- seq(from = max_ticks + 10, to = 500, by = 10)
    
    # to store new data
    new_df <- add_rows
    
    # create data frame with last tick data, extending
    # for all required ticks
    for(i in 1:length(add_ticks)){
      new_df <- bind_rows(new_df, add_rows)
    }
    
    # set ticks to run until 500
    new_df$ticks <- c(max_ticks, add_ticks)
    # add original data to extended data
    new_df <- bind_rows(work_with, new_df)
    # to send back to complete dataframe
    work_with <- new_df
  }
  # fill out new data frame with extended data
  # or original data where it didn't need to be extended
  ws_summary_timesteps_new <- bind_rows(ws_summary_timesteps_new, work_with)
}
# remove set-up data row
ws_summary_timesteps_new <- ws_summary_timesteps_new[-1, ] %>%
  distinct()

# pivot wider so that each time step is a data column
# each parameter combination will have 1 row of data
ws_summary_timesteps <- ws_summary_timesteps_new %>%
  filter(ticks %in% seq(from = 10, to = 500, by = 10)) %>%
  pivot_wider(names_from = ticks,
              values_from = c(sheep, wolves, grass,
                              sheep_noise, wolves_noise, grass_noise))
```

Save all data frames:
```{r}
# complete data (for time series analysis)
ws_summary %>%
  write_csv(file = 'data/processed/wolfsheep_timeseries_training.csv')
# time steps
ws_summary_timesteps %>%
  write_csv(file = 'data/processed/wolfsheep_timesteps_training.csv')
```