---
title: "WolfSheep_04_Training_SimpleRegression"
author: "Femke Keij S2647168"
date: "2023-07-12"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Clear working directory & set random seed:
```{r}
rm(list = ls(all = TRUE))

set.seed(42)
```

Packages used:
```{r}
# for importing / working with tidy data
library(tidyverse)

# for ggplot
library(directlabels)
library(patchwork)
library(ggbeeswarm)

# for creating the cross-validation folds
library(caret)
```

Functions used:
```{r}
source('scripts/WolfSheep/WolfSheep_Functions.R')
```

Read in the data:
```{r}
# training data
# ws_train <- read_csv('data/processed/wolfsheep_timesteps_training.csv')

ws_train <- read_csv('data/training/wolfsheep_training.csv')
```

# Fitting with cross-validation
We fit a separate regression for each input parameter. All output variables serve as predictors. We apply a 5-fold cross-validation, and obtain the error computations for each one. The errors are then averaged across the 5 folds.

Function to cross-validate linear regression
```{r}
WolfSheepSimpleRegressionFitting <- function(data,
                                      sample_size,
                                      sample_method,
                                      summarised_runs,
                                      noise,
                                      datapoints){
  # data: the data frame containing the input parameters as well as the relevant outputs
  # sample_size, sample_method, summarised_runs, noise, datapoints: as in training data frame
  
  # create the folds
  flds <- createFolds(1:nrow(data),
                      k = 5, list = TRUE, returnTrain = FALSE)

  # to store the results
  results_df <- tibble(fold = numeric(),
                       variable = character(),
                       perc_correct = numeric(),
                       perc_correct_cat = numeric(),
                       RMSE = numeric(),
                       NRMSE = numeric(),
                       point_pred = numeric())

  # for each cross-validation fold
  for(i in 1:5){
    # remove the test fold to create the training data
    dat_train <- data %>%
      filter(!combination_number %in% unlist(flds[i])) %>%
      select(- combination_number)
  
    # obtain the test fold
    dat_test <- data %>%
      filter(combination_number %in% unlist(flds[i])) %>%
      select(- combination_number)
  
    # train the linear regressions
    initial_sheep_lr <- lm(formula = initial_number_sheep ~ . 
                           - initial_number_wolves 
                           - sheep_gain_from_food 
                           - wolves_gain_from_food 
                           - sheep_reproduce 
                           - wolves_reproduce 
                           - grass_regrowth,
                           data = dat_train)
    initial_wolves_lr <- lm(formula = initial_number_wolves ~ . 
                           - initial_number_sheep 
                           - sheep_gain_from_food 
                           - wolves_gain_from_food 
                           - sheep_reproduce 
                           - wolves_reproduce 
                           - grass_regrowth,
                           data = dat_train)
    food_sheep_lr <- lm(formula = sheep_gain_from_food ~ . 
                          - initial_number_sheep
                          - initial_number_wolves
                           - wolves_gain_from_food 
                           - sheep_reproduce 
                           - wolves_reproduce 
                           - grass_regrowth,
                           data = dat_train)
    food_wolves_lr <- lm(formula = wolves_gain_from_food ~ . 
                           - initial_number_wolves
                           - initial_number_sheep
                           - sheep_gain_from_food
                           - sheep_reproduce 
                           - wolves_reproduce 
                           - grass_regrowth,
                           data = dat_train)
    rep_sheep_lr <- lm(formula = sheep_reproduce ~ . 
                           - initial_number_wolves
                           - initial_number_sheep
                           - sheep_gain_from_food 
                           - wolves_gain_from_food
                           - wolves_reproduce 
                           - grass_regrowth,
                           data = dat_train)
    rep_wolves_lr <- lm(formula = wolves_reproduce ~ . 
                           - initial_number_wolves
                           - initial_number_sheep
                           - sheep_gain_from_food 
                           - wolves_gain_from_food 
                           - sheep_reproduce
                           - grass_regrowth,
                           data = dat_train)
    grass_lr <- lm(formula = grass_regrowth ~ . 
                           - initial_number_wolves
                           - initial_number_sheep
                           - sheep_gain_from_food 
                           - wolves_gain_from_food 
                           - sheep_reproduce 
                           - wolves_reproduce,
                           data = dat_train)
   
    # predict the left-out fold
    pred_initial_sheep <- predict(initial_sheep_lr, data = dat_test)
    pred_initial_wolves <- predict(initial_wolves_lr, data = dat_test)
    pred_food_sheep <- predict(food_sheep_lr, data = dat_test)
    pred_food_wolves <- predict(food_wolves_lr, data = dat_test)
    pred_rep_sheep <- predict(rep_sheep_lr, data = dat_test)
    pred_rep_wolves <- predict(rep_sheep_lr, data = dat_test)
    pred_grass <- predict(grass_lr, data = dat_test)
    
    # compute mean input parameters in training data for
    # point prediction computation
    mean_initial_sheep <- mean(dat_train$initial_number_sheep)
    mean_initial_wolves <- mean(dat_train$initial_number_wolves)
    mean_food_sheep <- mean(dat_train$sheep_gain_from_food)
    mean_food_wolves <- mean(dat_train$wolves_gain_from_food)
    mean_rep_sheep <- mean(dat_train$sheep_reproduce)
    mean_rep_wolves <- mean(dat_train$wolves_reproduce)
    mean_grass <- mean(dat_train$grass_regrowth)
  
    # add error computations
    results_df <- results_df %>%
      add_row(ComputeErrorsContinuous(pred_initial_sheep,
                                      dat_test$initial_number_sheep,
                                      mean_initial_sheep,
                                      variable = 'initial number of sheep',
                                      fold = i)) %>%
      add_row(ComputeErrorsContinuous(pred_initial_wolves,
                                      dat_test$initial_number_wolves,
                                      mean_initial_sheep,
                                      variable = 'initial number of wolves',
                                      fold = i)) %>%
      add_row(ComputeErrorsContinuous(pred_food_sheep,
                                      dat_test$sheep_gain_from_food,
                                      mean_food_sheep,
                                      variable = 'sheep gain from food',
                                      fold = i)) %>%
      add_row(ComputeErrorsContinuous(pred_food_wolves,
                                      dat_test$wolves_gain_from_food,
                                      mean_food_wolves,
                                      variable = 'wolves gain from food',
                                      fold = i)) %>%
      add_row(ComputeErrorsContinuous(pred_rep_sheep,
                                      dat_test$sheep_reproduce,
                                      mean_rep_sheep,
                                      variable = 'probability sheep reproduce',
                                      fold = i)) %>%
      add_row(ComputeErrorsContinuous(pred_rep_wolves,
                                      dat_test$wolves_reproduce,
                                      mean_rep_wolves,
                                      variable = 'probability wolves reproduce',
                                      fold = i)) %>%
      add_row(ComputeErrorsContinuous(pred_grass,
                                      dat_test$grass_regrowth,
                                      mean_grass,
                                      variable = 'grass regrowth time',
                                      fold = i))
  }
  
  # compute mean of each statistic over the 5 folds
  results_df <- results_df %>%
    group_by(variable)%>%
    summarise_all(mean) %>%
    select(- fold) %>%
    # add the experiment info to the df
    add_column(sample_size = sample_size,
               sample_method = sample_method,
               summarised_runs = summarised_runs,
               noise = noise,
               datapoints = datapoints)
  
  return(results_df)
}
```

To perform:
1) select relevant sample size, sampling method, summarisation of runs, noise, and type of datapoints
2) select relevant data columns, include combination_number, ticks, outputs, and input parameters
3) pivot wider to make each time step a column
4) feed to fitting function

```{r}
out_1 <- WolfSheepSimpleRegression(ws_train %>%
                                     filter(sample_size == 40,
                                            sample_method == 'trial',
                                            summarised_runs ==
                                              'summarised',
                                            noise == 'clean',
                                            datapoints = 'timesteps'),
                                   sample_size = 40,
                                   sample_method = 'trial',
                                   summarised_runs = 'summarised',
                                   noise = 'clean',
                                   datapoints = 'timesteps')

ws_trial <- ws_train %>% 
  filter(sample_size == 40,
         sample_method == 'trial',
         # add in summarisation here
         noise == 'noise',
         datapoints == 'timesteps',
         # select every 10 timesteps
         ticks %% 10 == 0) %>%
  select(combination_number, ticks, sheep, wolves, grass,
         initial_number_sheep, initial_number_wolves,
         sheep_gain_from_food, wolves_gain_from_food,
         sheep_reproduce, wolves_reproduce, grass_regrowth,
         mean_sheep, mean_wolves, mean_grass, 
         min_sheep, max_sheep, sd_sheep, trend_sheep,
         min_wolves, max_wolves, sd_wolves, trend_wolves,
         min_grass, max_grass, sd_grass, trend_grass) %>%
  # transform into wide format for regression
  pivot_wider(names_from = ticks,
              values_from = c(sheep, wolves, grass))
```



1) no noise, 10 steps, random sampling

2) no noise, 20 steps, random sampling

3) no noise, 50 steps, random sampling

4) no noise, endpoint, random sampling

4) no noise, 10 steps, lhs

5) no noise, 20 steps, lhs

6) no noise, 50 steps, lhs

7) no noise, endpoints, lhs

1) no noise, 10 steps, random sampling

2) no noise, 20 steps, random sampling

3) no noise, 50 steps, random sampling

4) no noise, 10 steps, lhs

5) no noise, 20 steps, lhs

6) no noise, 50 steps, random sampling

# Visualise results
Compare each error metric:
```{r}
VisualiseErrorMetrics(out = out,
                      noise = FALSE)

VisualiseErrorMetrics(out = out,
                      noise = TRUE)
```